# AutoVend 技术实现设计文档

## 1. 系统架构

### 1.1 整体架构

AutoVend 系统采用模块化架构设计，主要分为以下几个核心模块：

- **对话管理模块**：管理与OpenAI的对话交互，处理对话流程
- **用户画像模块**：负责用户信息的提取、存储和管理
- **需求分析模块**：处理显性和隐性购车需求的识别和管理
- **推荐引擎**：基于用户画像和需求分析进行车型推荐
- **API服务**：提供RESTful API接口，支持前端和第三方系统集成

### 1.2 技术选型

- **后端框架**：FastAPI (Python)
- **对话引擎**：OpenAI API (GPT-4/GPT-3.5)
- **自然语言处理**：主要依赖OpenAI，辅以简单规则提取
- **数据存储**：SQLite（本地开发）/ JSON文件存储
- **API文档**：Swagger UI（FastAPI内置）
- **前端界面**：Streamlit（可选，用于快速开发演示界面）

## 2. 核心模块设计

### 2.1 对话管理模块

#### 2.1.1 数据模型

```python
class ChatMessage:
    message_id: str
    role: str  # 'user', 'system', 'assistant'
    content: str
    timestamp: datetime
    
class ChatSession:
    session_id: str
    profile_id: Optional[str]
    phone_number: Optional[str]
    messages: List[ChatMessage]
    created_at: datetime
    updated_at: datetime
    stage: str  # welcome, needs_analysis, confirmation, dealership
    
    context: dict  # 保存对话上下文和状态
```

#### 2.1.2 主要功能

- **会话初始化**：创建新会话，设置初始系统提示
- **消息处理**：处理用户消息并调用OpenAI API生成回复
- **上下文管理**：维护对话历史和上下文信息
- **状态转换**：管理对话的状态流转
- **提取处理**：从对话中提取用户信息和需求

#### 2.1.3 接口定义

```python
def create_session(phone_number: Optional[str] = None) -> ChatSession:
    """创建新的聊天会话"""

def add_message(session_id: str, content: str, role: str = "user") -> ChatMessage:
    """添加新消息到会话"""
    
def generate_response(session_id: str) -> ChatMessage:
    """根据当前会话生成系统回复"""
    
def extract_information(session_id: str) -> dict:
    """从会话中提取用户信息和需求"""
```

### 2.2 用户画像模块

#### 2.2.1 数据模型

```python
class UserProfile:
    # 基本信息
    profile_id: str
    phone_number: str
    age: Optional[str]
    user_title: Optional[str]
    name: Optional[str]
    target_driver: Optional[str]
    expertise: Optional[int]  # 0-10级汽车知识水平
    
    # 附加信息
    family_size: Optional[int]
    price_sensitivity: Optional[str]  # High, Medium, Low
    residence: Optional[str]  # 居住地，格式：国家+省份+城市
    parking_conditions: Optional[str]
    
    # 动态标签
    tags: Dict[str, Any]
    
    # 关联信息
    connections: List[ConnectionInfo]
```

#### 2.2.2 主要功能

- **信息提取**：从对话中提取用户信息
- **画像创建**：根据提取的信息创建用户画像
- **画像更新**：动态更新用户信息
- **标签生成**：根据用户信息生成标签
- **关联管理**：管理用户之间的关联关系

#### 2.2.3 接口定义

```python
def create_profile(session_id: str, initial_info: dict = None) -> UserProfile:
    """创建新的用户画像"""
    
def update_profile(profile_id: str, update_info: dict) -> UserProfile:
    """更新用户画像信息"""
    
def generate_tags(profile_id: str) -> Dict[str, str]:
    """根据用户画像生成标签"""
    
def get_profile(profile_id: str) -> UserProfile:
    """获取用户画像"""
```

### 2.3 需求分析模块

#### 2.3.1 数据模型

```python
class CarNeed:
    value: str
    is_implicit: bool  # 是否为隐性需求
    confidence: float  # 置信度
    source: str  # 来源：用户直接表述、系统推断等
    
class CarNeeds:
    profile_id: str
    
    # 显性需求
    budget: Optional[CarNeed]
    brand: List[CarNeed]
    vehicle_category_bottom: List[CarNeed]
    color: List[CarNeed]
    
    # 性能需求
    engine_type: List[CarNeed]
    transmission: List[CarNeed]
    fuel_efficiency: Optional[CarNeed]
    
    # 功能和舒适度
    seats: Optional[CarNeed]
    sunroof: Optional[CarNeed]
    entertainment: List[CarNeed]
    safety_features: List[CarNeed]
    
    # 隐性需求
    size: Optional[CarNeed]
    usage: List[CarNeed]  # 城市驾驶、越野、家庭等
    style: List[CarNeed]  # 豪华、运动、实用等
    
    # 自定义需求
    custom_needs: Dict[str, CarNeed]
```

#### 2.3.2 主要功能

- **显性需求提取**：识别用户直接表述的需求
- **隐性需求推断**：根据用户画像和对话内容推断隐性需求
- **需求冲突处理**：处理需求之间的冲突关系
- **需求粒度控制**：根据用户专业程度调整需求展示粒度

#### 2.3.3 接口定义

```python
def extract_explicit_needs(text: str) -> Dict[str, Any]:
    """从文本中提取显性需求"""
    
def infer_implicit_needs(profile_id: str, explicit_needs: Dict[str, Any]) -> Dict[str, Any]:
    """根据用户画像和显性需求推断隐性需求"""
    
def add_need(profile_id: str, category: str, value: str, is_implicit: bool = False) -> None:
    """添加需求项"""
    
def remove_need(profile_id: str, category: str, value: Optional[str] = None) -> None:
    """移除需求项"""
    
def get_needs(profile_id: str) -> Dict[str, Any]:
    """获取用户的所有需求"""
```

### 2.4 推荐引擎

#### 2.4.1 数据模型

```python
class Vehicle:
    vehicle_id: str
    brand: str
    model: str
    category: str
    price: float
    specs: Dict[str, Any]
    features: List[str]
    
class Recommendation:
    profile_id: str
    recommendations: List[Tuple[Vehicle, float]]  # 车型及匹配度
    created_at: datetime
    reasoning: Dict[str, str]  # 推荐理由
```

#### 2.4.2 主要功能

- **车型匹配**：根据用户需求匹配合适的车型
- **特性解释**：根据用户关注点解释车型特性
- **匹配度计算**：计算每个车型与用户需求的匹配度

#### 2.4.3 接口定义

```python
def generate_recommendations(profile_id: str, limit: int = 5) -> List[Recommendation]:
    """根据用户画像和需求生成推荐车型"""
    
def explain_recommendation(profile_id: str, vehicle_id: str) -> Dict[str, str]:
    """解释为何向特定用户推荐特定车型"""
    
def get_vehicle_details(vehicle_id: str) -> Vehicle:
    """获取车型详细信息"""
```

### 2.5 OpenAI集成模块

#### 2.5.1 主要功能

- **API调用管理**：处理与OpenAI API的通信
- **提示工程**：设计和优化与OpenAI交互的提示
- **响应解析**：解析OpenAI返回的响应内容

#### 2.5.2 接口定义

```python
def create_completion(messages: List[dict], system_prompt: Optional[str] = None) -> str:
    """调用OpenAI API生成回复"""
    
def extract_structured_data(text: str, schema: Dict[str, Any]) -> Dict[str, Any]:
    """使用OpenAI从文本中提取结构化数据"""
    
def analyze_sentiment(text: str) -> Dict[str, float]:
    """分析文本的情感倾向"""
```

## 3. API接口设计

### 3.1 对话API

```
POST /api/chat/new
GET /api/chat/{session_id}
POST /api/chat/{session_id}/message
```

### 3.2 用户画像API

```
GET /api/profile/{profile_id}
PATCH /api/profile/{profile_id}
```

### 3.3 需求分析API

```
GET /api/needs/{profile_id}
POST /api/needs/{profile_id}
DELETE /api/needs/{profile_id}/{category}
```

### 3.4 推荐API

```
GET /api/recommendations/{profile_id}
GET /api/vehicles/{vehicle_id}
```

## 4. 数据存储设计

### 4.1 本地存储方案

初始阶段使用简单的文件存储系统：

```
/data
  /sessions  # 会话数据
    {session_id}.json
  /profiles  # 用户画像数据
    {profile_id}.json
  /needs     # 需求数据
    needs_{profile_id}.json
  /vehicles  # 车型数据
    vehicles.json
```

后期可考虑迁移至SQLite：

```python
# 示例数据库表结构
chat_sessions (session_id, profile_id, phone_number, created_at, updated_at, stage)
chat_messages (message_id, session_id, role, content, timestamp)
user_profiles (profile_id, phone_number, name, ..., created_at, updated_at)
user_needs (need_id, profile_id, category, value, is_implicit, confidence)
vehicles (vehicle_id, brand, model, category, price, ...)
```

## 5. 实现策略

### 5.1 短期实现目标

- 实现基础对话管理和OpenAI集成
- 开发简单的用户画像提取功能
- 实现基本的显性需求识别
- 创建简单的车型数据库和匹配逻辑
- 构建基础API服务

### 5.2 中期实现目标

- 增强用户画像的准确性和丰富度
- 改进隐性需求推断能力
- 优化对话体验和流程
- 扩展车型数据库

## 6. 安全措施

- API认证与授权
- 数据加密
- 输入验证和清洗
- 日志记录与审计

## 7. 测试策略

### 7.1 单元测试

为核心功能编写单元测试，特别是：
- 信息提取算法
- 需求推断逻辑
- 对话状态管理

### 7.2 集成测试

测试模块之间的交互，特别是：
- 用户画像与需求分析之间的交互
- 对话管理与NLP处理之间的交互

### 7.3 端到端测试

模拟完整对话流程，验证系统行为符合预期

## 8. 开发路线图

### 8.1 第一阶段：基础架构

- 实现核心数据模型
- 开发基本NLP处理功能
- 实现简单对话流程
- 搭建API框架

### 8.2 第二阶段：功能完善

- 增强需求推断能力
- 完善用户画像提取
- 丰富对话流程
- 开发基础推荐功能

### 8.3 第三阶段：优化和扩展

- 引入机器学习模型
- 对接实际车型数据库
- 优化用户体验
- 增加性能监控和分析 